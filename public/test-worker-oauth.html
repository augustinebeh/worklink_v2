<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkLink OAuth Test</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a1a; color: white; }
        .test-result { margin: 10px 0; padding: 10px; background: #2a2a2a; border-radius: 5px; }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .warning { background: #5a4d2d; }
        button { padding: 10px 20px; margin: 5px; background: #0066cc; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0052a3; }
        #log { background: #111; padding: 15px; margin-top: 20px; border-radius: 5px; height: 300px; overflow-y: auto; font-family: monospace; }
    </style>
</head>
<body>
    <h1>WorkLink Google OAuth Debug Tool</h1>

    <div class="test-result">
        <h3>Step 1: Test API Endpoints</h3>
        <button onclick="testEndpoints()">Test Auth Endpoints</button>
        <div id="endpoint-results"></div>
    </div>

    <div class="test-result">
        <h3>Step 2: Test Google OAuth Config</h3>
        <button onclick="testGoogleConfig()">Test Google Config</button>
        <div id="google-config-results"></div>
    </div>

    <div class="test-result">
        <h3>Step 3: Initialize Google Sign-In</h3>
        <button onclick="initializeGoogle()">Initialize Google OAuth</button>
        <div id="google-signin" style="margin-top: 10px;"></div>
        <div id="google-init-results"></div>
    </div>

    <div class="test-result">
        <h3>Step 4: Manual Login Test</h3>
        <button onclick="testManualLogin()">Test Manual Login</button>
        <div id="manual-login-results"></div>
    </div>

    <div id="log"></div>

    <script>
        let googleClientId = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#74c0fc';
            logDiv.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testEndpoints() {
            log('Testing auth endpoints...', 'info');
            const resultsDiv = document.getElementById('endpoint-results');

            try {
                // Test auth health
                const healthRes = await fetch('/api/v1/auth/health');
                const healthData = await healthRes.json();
                log(`Auth health: ${JSON.stringify(healthData)}`, 'success');

                // Test auth index
                const indexRes = await fetch('/api/v1/auth/');
                const indexData = await indexRes.json();
                log(`Auth index: Available endpoints found`, 'success');

                resultsDiv.innerHTML = '<div class="success">✅ Auth endpoints accessible</div>';
            } catch (error) {
                log(`Endpoint test failed: ${error.message}`, 'error');
                resultsDiv.innerHTML = '<div class="error">❌ Auth endpoints failed</div>';
            }
        }

        async function testGoogleConfig() {
            log('Testing Google OAuth configuration...', 'info');
            const resultsDiv = document.getElementById('google-config-results');

            try {
                const response = await fetch('/api/v1/auth/google/config');
                const data = await response.json();

                log(`Google config response: ${JSON.stringify(data)}`, 'info');

                if (data.success) {
                    googleClientId = data.clientId;
                    resultsDiv.innerHTML = `<div class="success">✅ Google Client ID: ${data.clientId}</div>`;
                    log(`Google Client ID obtained: ${data.clientId}`, 'success');
                } else {
                    resultsDiv.innerHTML = `<div class="error">❌ ${data.error}</div>`;
                    log(`Google config error: ${data.error}`, 'error');
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">❌ Failed to fetch config: ${error.message}</div>`;
                log(`Google config fetch failed: ${error.message}`, 'error');
            }
        }

        function initializeGoogle() {
            log('Initializing Google Sign-In...', 'info');
            const resultsDiv = document.getElementById('google-init-results');
            const signinDiv = document.getElementById('google-signin');

            if (!googleClientId) {
                resultsDiv.innerHTML = '<div class="error">❌ Please test Google config first</div>';
                log('Google Client ID not available', 'error');
                return;
            }

            if (typeof google === 'undefined') {
                resultsDiv.innerHTML = '<div class="error">❌ Google GSI library not loaded</div>';
                log('Google GSI library not loaded', 'error');
                return;
            }

            try {
                google.accounts.id.initialize({
                    client_id: googleClientId,
                    callback: handleGoogleAuth,
                    auto_select: false,
                    cancel_on_tap_outside: true,
                });

                google.accounts.id.renderButton(signinDiv, {
                    type: 'standard',
                    theme: 'filled_blue',
                    size: 'large',
                    text: 'signin_with',
                    shape: 'rectangular',
                });

                resultsDiv.innerHTML = '<div class="success">✅ Google Sign-In initialized</div>';
                log('Google Sign-In button rendered successfully', 'success');

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">❌ Initialization failed: ${error.message}</div>`;
                log(`Google initialization failed: ${error.message}`, 'error');
            }
        }

        async function handleGoogleAuth(response) {
            log('Google authentication callback triggered', 'info');
            log(`Received credential: ${response.credential?.substring(0, 50)}...`, 'info');

            try {
                const loginResponse = await fetch('/api/v1/auth/google/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        credential: response.credential,
                        referralCode: ''
                    }),
                });

                const data = await loginResponse.json();
                log(`Login response: ${JSON.stringify(data)}`, data.success ? 'success' : 'error');

                if (data.success) {
                    alert('✅ Google authentication successful!');
                } else {
                    alert(`❌ Google authentication failed: ${data.error}`);
                }
            } catch (error) {
                log(`Login request failed: ${error.message}`, 'error');
                alert(`❌ Login request failed: ${error.message}`);
            }
        }

        async function testManualLogin() {
            log('Testing manual Google login...', 'info');
            const resultsDiv = document.getElementById('manual-login-results');

            if (!googleClientId) {
                resultsDiv.innerHTML = '<div class="error">❌ Please test Google config first</div>';
                return;
            }

            // Create a test JWT token for validation (this will fail but show us the error)
            const testCredential = 'eyJhbGciOiJSUzI1NiIsImtpZCI6IjU5MjAyYzA5NmY4YzI1ZjM1YzkwMGZmM2JjNGFiNWQ5NjAzZDkwMjMiLCJ0eXAiOiJKV1QifQ.test.token';

            try {
                const response = await fetch('/api/v1/auth/google/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        credential: testCredential,
                        referralCode: ''
                    }),
                });

                const data = await response.json();
                log(`Manual login test response: ${JSON.stringify(data)}`, 'info');

                if (data.error && data.error.includes('Invalid Google authentication')) {
                    resultsDiv.innerHTML = '<div class="success">✅ Login endpoint working (correctly rejects invalid token)</div>';
                    log('Login endpoint working correctly', 'success');
                } else {
                    resultsDiv.innerHTML = `<div class="warning">⚠️ Unexpected response: ${data.error || 'Unknown'}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">❌ Manual login test failed: ${error.message}</div>`;
                log(`Manual login test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run some tests on page load
        window.onload = function() {
            log('WorkLink OAuth Debug Tool loaded', 'info');
            log('Please run the tests in order: Endpoints → Google Config → Initialize Google', 'info');
        };

        // Check for Google GSI library
        function checkGoogleLibrary() {
            if (typeof google !== 'undefined') {
                log('Google GSI library loaded successfully', 'success');
            } else {
                log('Waiting for Google GSI library...', 'info');
                setTimeout(checkGoogleLibrary, 1000);
            }
        }
        checkGoogleLibrary();
    </script>
</body>
</html>