#!/usr/bin/env bash

# Pre-commit hook for WorkLink v2
# Checks file sizes only ‚Äî ESLint is handled by CI

echo "üîç Running pre-commit checks..."
echo ""

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Track warnings and errors
WARNINGS=0
ERRORS=0

# Get staged JavaScript/JSX files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx)$' | grep -v 'node_modules/')

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No JavaScript files to check"
  exit 0
fi

echo "üìã Checking JavaScript files..."
echo ""

# Files exempt from the 1000-line limit (schema/migration files grow naturally)
EXEMPT_FILES="db/schema.js"

# Check file sizes
for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    LINES=$(wc -l < "$FILE" | tr -d ' ')

    # Skip exempt files for critical check (still warn)
    IS_EXEMPT=false
    for EXEMPT in $EXEMPT_FILES; do
      if [ "$FILE" = "$EXEMPT" ]; then
        IS_EXEMPT=true
        break
      fi
    done

    if [ "$LINES" -gt 1000 ] && [ "$IS_EXEMPT" = true ]; then
      echo -e "${YELLOW}‚ö†Ô∏è  EXEMPT: $FILE has $LINES lines (schema/migrations file)${NC}"
      WARNINGS=$((WARNINGS + 1))
    elif [ "$LINES" -gt 1000 ]; then
      echo -e "${RED}‚ùå CRITICAL: $FILE has $LINES lines (limit: 1000)${NC}"
      echo "   ‚Üí This file MUST be refactored before committing"
      ERRORS=$((ERRORS + 1))
    elif [ "$LINES" -gt 500 ]; then
      echo -e "${YELLOW}‚ö†Ô∏è  WARNING: $FILE has $LINES lines (recommended: <500)${NC}"
      echo "   ‚Üí Consider refactoring this file"
      WARNINGS=$((WARNINGS + 1))
    else
      echo -e "${GREEN}‚úÖ $FILE ($LINES lines)${NC}"
    fi
  fi
done

echo ""
echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

# Summary
if [ $ERRORS -gt 0 ]; then
  echo -e "${RED}‚ùå COMMIT BLOCKED: $ERRORS critical issue(s) found${NC}"
  echo "   Files over 1000 lines must be refactored before committing."
  echo "   Use 'git commit --no-verify' to bypass (not recommended)"
  exit 1
fi

if [ $WARNINGS -gt 0 ]; then
  echo -e "${YELLOW}‚ö†Ô∏è  $WARNINGS warning(s) ‚Äî proceeding with commit${NC}"
fi

echo -e "${GREEN}‚úÖ Pre-commit checks passed!${NC}"
exit 0
