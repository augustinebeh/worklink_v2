#!/usr/bin/env bash

# Pre-commit hook for WorkLink v2
# Checks file sizes and code quality

echo "ğŸ” Running pre-commit checks..."
echo ""

# Color codes
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Track warnings and errors
WARNINGS=0
ERRORS=0

# Get staged JavaScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.js$' | grep -v 'node_modules/')

if [ -z "$STAGED_FILES" ]; then
  echo "âœ… No JavaScript files to check"
  exit 0
fi

echo "ğŸ“‹ Checking JavaScript files..."
echo ""

# Check file sizes
for FILE in $STAGED_FILES; do
  if [ -f "$FILE" ]; then
    LINES=$(wc -l < "$FILE" | tr -d ' ')
    
    if [ "$LINES" -gt 1000 ]; then
      echo -e "${RED}âŒ CRITICAL: $FILE has $LINES lines (limit: 1000)${NC}"
      echo "   â†’ This file MUST be refactored before committing"
      ERRORS=$((ERRORS + 1))
    elif [ "$LINES" -gt 500 ]; then
      echo -e "${YELLOW}âš ï¸  WARNING: $FILE has $LINES lines (recommended: <500)${NC}"
      echo "   â†’ Consider refactoring this file"
      WARNINGS=$((WARNINGS + 1))
    else
      echo -e "${GREEN}âœ… $FILE ($LINES lines)${NC}"
    fi
  fi
done

echo ""

# Run ESLint on staged files
if command -v npx &> /dev/null; then
  echo "ğŸ”§ Running ESLint on staged files..."
  echo "$STAGED_FILES" | xargs npx eslint --quiet
  ESLINT_EXIT=$?
  
  if [ $ESLINT_EXIT -ne 0 ]; then
    echo ""
    echo -e "${YELLOW}âš ï¸  ESLint found issues. Fix them or use --no-verify to skip.${NC}"
    WARNINGS=$((WARNINGS + 1))
  fi
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Summary
if [ $ERRORS -gt 0 ]; then
  echo -e "${RED}âŒ COMMIT BLOCKED: $ERRORS critical issue(s) found${NC}"
  echo "   Files over 1000 lines must be refactored before committing."
  echo "   Use 'git commit --no-verify' to bypass (not recommended)"
  exit 1
fi

if [ $WARNINGS -gt 0 ]; then
  echo -e "${YELLOW}âš ï¸  WARNING: $WARNINGS issue(s) found${NC}"
  echo "   Consider addressing these before committing."
  echo "   Commit will proceed in 3 seconds..."
  sleep 3
fi

echo -e "${GREEN}âœ… Pre-commit checks passed!${NC}"
exit 0
